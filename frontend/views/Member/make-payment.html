<style>
    #paymentForm input {
        background-color: white;
    }

    .paymentCard h2,
    h3 {
        color: #2c3e50;
        margin-bottom: 20px;
        text-align: center;
    }

    #paymentForm input,
    #paymentForm select {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
    }

    #paymentForm input:focus,
    #paymentForm select:focus {
        outline: none;
        border-color: #1abc9c;
    }

    #paymentForm button {
        width: 100%;
        padding: 10px;
        background-color: #1abc9c;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
        font-size: 16px;
    }

    #paymentForm button:hover {
        background-color: #16a085;
    }

    #paymentSection {
        margin-top: 20px;
    }

    #paymentCard {
        margin-top: 10px;
        background-color: #ecf0f1;
        max-height: 100vh;
        height: 500px;
        overflow-y: hidden;
        overflow-x: hidden;
        padding: 20px;
        border-radius: 10px;
        /* width: 100%; */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
</style>

<section id="content">
    <h2 id="contentTitle">Payment</h2>
    <div id="paymentCard">
        <div class="row">
            <div class="col-12">
                <div id="paymentSection">
                    <form id="paymentForm">
                        <select id="monthsSelect" class="form-input"></select>

                        <label for="amount">Amount (LKR):</label>
                        <input type="number" id="amount" placeholder="Enter amount" required>

                        <label for="receiptNumber">Receipt Number:</label>
                        <input type="text" id="receiptNumber" placeholder="Enter receipt number" required>

                        <label for="receiptUpload">Upload Receipt:</label>
                        <input type="file" id="receiptUpload" required>

                        <button type="submit" class="btn">Pay</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const membersUrl = "http://localhost:7000/Members";
        const lastIdUrl = "http://localhost:7000/LastId";
        const trainingProgramActivitiesUrl = "http://localhost:7000/TrainingProgramActivities";
        const enrolledTrainingProgramsUrl = "http://localhost:7000/EnrolledTrainingPrograms";
        const paymentsUrl = "http://localhost:7000/Payments";
        const approvalRequestsUrl = "http://localhost:7000/ApprovalRequests";

        let approvalRequests = [];
        let lastIds = [];
        let members = [];
        let payments = [];
        let trainingProgramActivities = [];
        let enrolledPrograms = [];
        let enrollMonths = [{ period: 1, discount: 0 }, { period: 3, discount: 10 }, { period: 6, discount: 15 }, { period: 12, discount: 25 },];
        let finalAmount = 0;

        const paymentResponse = await fetch(paymentsUrl);
        payments = await paymentResponse.json();

        const memberResponse = await fetch(membersUrl);
        members = await memberResponse.json();

        const activitiesResponse = await fetch(trainingProgramActivitiesUrl);
        trainingProgramActivities = await activitiesResponse.json();

        const enrolledProgramsResponse = await fetch(enrolledTrainingProgramsUrl);
        enrolledPrograms = await enrolledProgramsResponse.json();

        const lastidsResponse = await fetch(lastIdUrl);
        lastIds = await lastidsResponse.json();

        const monthSelect = document.getElementById('monthsSelect');
        monthSelect.innerHTML = '';
        let defaultMonthOption = document.createElement('option');
        defaultMonthOption.text = "Select Month";
        defaultMonthOption.value = 1;
        monthSelect.appendChild(defaultMonthOption);

        enrollMonths.forEach(month => {
            const option = document.createElement('option');
            option.value = month.period;
            option.text = `${month.period} - Discount ${month.discount} %`;
            monthSelect.appendChild(option);
        });

        const memberPrograms = enrolledPrograms.filter(program => program.MemberID === loggedInUser.id);
        console.log(memberPrograms)
        const totalPayment = memberPrograms.reduce((total, program) => {
            const activity = trainingProgramActivities.find(activity => activity.ActivittID === program.ActivittID);
            return total + (activity ? activity.Cost : 0);
        }, 0);

        console.log(totalPayment);

        document.getElementById('amount').value = totalPayment;

        document.getElementById("monthsSelect").addEventListener("change", () => {
            finalAmount = 0;
            const selectedMonths = Number(document.getElementById('monthsSelect').value);
            finalAmount = calculateDiscountedAmount(totalPayment, selectedMonths);
            document.getElementById('amount').value = finalAmount;
        });

        document.getElementById('paymentForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const memberId = loggedInUser.id;
            console.log(memberId);

            const response = await fetch(approvalRequestsUrl);
            approvalRequests = await response.json();
            console.log(approvalRequestsUrl);

            const amount = finalAmount;
            const receiptNumber = document.getElementById('receiptNumber').value.trim();
            const receiptFile = document.getElementById('receiptUpload').files[0];
            const selectedMonths = Number(document.getElementById('monthsSelect').value);

            const paidDate = new Date();
            const dueDate = new Date();

            let paymentType = "Monthly";
            if (selectedMonths === 1) {
                dueDate.setDate(paidDate.getDate() + 30); // Set due date to 30 days from today
            } else if (selectedMonths === 3) {
                paymentType = "Quarterly";
                dueDate.setDate(paidDate.getDate() + 90); // Set due date to 90 days (approx. 3 months)
            } else if (selectedMonths === 6) {
                paymentType = "Half-Yearly";
                dueDate.setDate(paidDate.getDate() + 180); // Set due date to 180 days (approx. 6 months)
            } else if (selectedMonths === 12) {
                paymentType = "Annually";
                dueDate.setDate(paidDate.getDate() + 365); // Set due date to 365 days (1 year)
            }

            if (amount && receiptNumber && receiptFile) {
                const newApprovalRequest = {
                    id: generateID("AR", lastIds.ApprovalRequestID),
                    RequestType: "payment",
                    MemberID: memberId,
                    PaymentType: paymentType,
                    Amount: parseFloat(amount),
                    ReceiptNumber: receiptNumber,
                    PaidDate: paidDate.toISOString().split('T')[0],
                    DueDate: dueDate.toISOString().split('T')[0],
                    Status: "pending"
                };

                const postResponse = await postApi(approvalRequestsUrl, newApprovalRequest);
                if (postResponse.ok) {
                    lastIds.ApprovalRequestID++
                    updateLastId(lastIds);
                    alert('Payment request sent to admin for approval!');
                    location.reload();
                }
            } else {
                alert('Please complete all fields.');
            }

        });

        function calculateDiscountedAmount(amount, months) {
            let finalAmount;

            switch (months) {
                case 1:
                    finalAmount = amount;
                    break;
                case 3:
                    finalAmount = amount - (amount * 0.10);
                    break;
                case 6:
                    finalAmount = amount - (amount * 0.15);
                    break;
                case 12:
                    finalAmount = amount - (amount * 0.25);
                    break;
            }

            console.log(finalAmount)
            if (months === 1) {
                return finalAmount;
            } else {
                return Math.ceil(finalAmount / 100) * 100;
            }
        }
    })
</script>